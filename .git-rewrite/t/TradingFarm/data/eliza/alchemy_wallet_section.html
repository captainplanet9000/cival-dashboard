<!-- Wallet Management Section -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-wallet me-2"></i>
                    Wallet Management
                </div>
                <div>
                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createWalletModal">
                        <i class="fas fa-plus me-1"></i>Create Wallet
                    </button>
                    <button class="btn btn-sm btn-primary" id="refreshWallets">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Network</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="walletsList">
                            <!-- Wallets will be loaded here -->
                            <tr>
                                <td colspan="5" class="text-center">Loading wallets...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wallet Details Section -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card" id="walletDetailsCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-info-circle me-2"></i>
                    Wallet Details
                </div>
                <button type="button" class="btn-close" id="closeWalletDetails"></button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Basic Information</h5>
                                <div class="mb-2">
                                    <strong>Name:</strong> <span id="walletDetailName"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Address:</strong> <span id="walletDetailAddress"></span>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" id="copyWalletAddress">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="mb-2">
                                    <strong>Network:</strong> <span id="walletDetailNetwork"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Balance:</strong> <span id="walletDetailBalance"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Created:</strong> <span id="walletDetailCreated"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Actions</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sendTransactionModal">
                                        <i class="fas fa-paper-plane me-2"></i>Send Transaction
                                    </button>
                                    <button class="btn btn-secondary" id="assignWalletButton" data-bs-toggle="modal" data-bs-target="#assignWalletModal">
                                        <i class="fas fa-user-tag me-2"></i>Assign to Agent
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Token Balances -->
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Token Balances</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>Symbol</th>
                                        <th>Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tokenBalancesList">
                                    <tr>
                                        <td colspan="4" class="text-center">No tokens found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- NFT Balances -->
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h5 class="card-title">NFT Collection</h5>
                        <div class="row" id="nftCollection">
                            <div class="col-12 text-center">No NFTs found</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Transactions -->
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">Recent Transactions</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>From/To</th>
                                        <th>Value</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsList">
                                    <tr>
                                        <td colspan="5" class="text-center">No transactions found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Wallet Modal -->
<div class="modal fade" id="createWalletModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Wallet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createWalletForm">
                    <div class="mb-3">
                        <label for="walletName" class="form-label">Wallet Name</label>
                        <input type="text" class="form-control" id="walletName" required>
                    </div>
                    <div class="mb-3">
                        <label for="walletNetwork" class="form-label">Network</label>
                        <select class="form-select" id="walletNetwork" required>
                            <option value="ethereum">Ethereum</option>
                            <option value="polygon">Polygon</option>
                            <option value="arbitrum">Arbitrum</option>
                            <option value="optimism">Optimism</option>
                            <option value="base">Base</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="walletNetworkType" class="form-label">Network Type</label>
                        <select class="form-select" id="walletNetworkType" required>
                            <option value="goerli">Testnet (Goerli/Mumbai)</option>
                            <option value="mainnet">Mainnet</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="walletPassword" class="form-label">Password (Optional)</label>
                        <input type="password" class="form-control" id="walletPassword">
                        <div class="form-text">Secures your wallet with a password</div>
                    </div>
                    <div class="mb-3">
                        <label for="walletPrivateKey" class="form-label">Private Key (Optional)</label>
                        <input type="text" class="form-control" id="walletPrivateKey">
                        <div class="form-text">Import an existing wallet with private key</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createWalletButton">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Send Transaction Modal -->
<div class="modal fade" id="sendTransactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sendTransactionForm">
                    <input type="hidden" id="txWalletId">
                    <div class="mb-3">
                        <label for="txToAddress" class="form-label">Recipient Address</label>
                        <input type="text" class="form-control" id="txToAddress" required>
                    </div>
                    <div class="mb-3">
                        <label for="txAmount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="txAmount" step="0.000001" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="txToken" class="form-label">Token</label>
                        <select class="form-select" id="txToken">
                            <option value="">Native Token (ETH/MATIC)</option>
                            <!-- Token options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="txGasSpeed" class="form-label">Gas Price</label>
                        <select class="form-select" id="txGasSpeed">
                            <option value="slow">Slow (Lowest Fee)</option>
                            <option value="average" selected>Average</option>
                            <option value="fast">Fast (Highest Fee)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="txPassword" class="form-label">Wallet Password (if required)</label>
                        <input type="password" class="form-control" id="txPassword">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendTransactionButton">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Wallet Modal -->
<div class="modal fade" id="assignWalletModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Wallet to Agent</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="assignWalletForm">
                    <input type="hidden" id="assignWalletId">
                    <div class="mb-3">
                        <label for="assignAgentId" class="form-label">Agent ID</label>
                        <input type="text" class="form-control" id="assignAgentId" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAssignButton">Assign</button>
            </div>
        </div>
    </div>
</div>

<!-- Wallet Management Script -->
<script>
    // Current selected wallet ID
    let currentWalletId = null;
    
    // Initialize wallet section
    function initializeWalletSection() {
        // Load wallets on initialization
        loadWallets();
        
        // Set up event listeners
        document.getElementById('refreshWallets').addEventListener('click', loadWallets);
        document.getElementById('createWalletButton').addEventListener('click', createWallet);
        document.getElementById('closeWalletDetails').addEventListener('click', () => {
            document.getElementById('walletDetailsCard').style.display = 'none';
        });
        document.getElementById('copyWalletAddress').addEventListener('click', copyWalletAddress);
        document.getElementById('sendTransactionButton').addEventListener('click', sendTransaction);
        document.getElementById('confirmAssignButton').addEventListener('click', assignWalletToAgent);
    }
    
    // Load wallets from API
    async function loadWallets() {
        try {
            const response = await fetchAPI('/alchemy/wallets');
            if (response && response.success) {
                const walletsList = document.getElementById('walletsList');
                
                if (response.wallets.length === 0) {
                    walletsList.innerHTML = '<tr><td colspan="5" class="text-center">No wallets found</td></tr>';
                    return;
                }
                
                walletsList.innerHTML = '';
                
                response.wallets.forEach(wallet => {
                    const networkBadge = getNetworkBadge(wallet.network, wallet.network_type);
                    const balance = wallet.balance ? `${parseFloat(wallet.balance).toFixed(6)} ${getNetworkSymbol(wallet.network)}` : 'Unknown';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${wallet.name}</td>
                        <td>${truncateAddress(wallet.address)}</td>
                        <td>${networkBadge}</td>
                        <td>${balance}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-wallet-btn" data-id="${wallet.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    walletsList.appendChild(row);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-wallet-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const walletId = button.getAttribute('data-id');
                        viewWalletDetails(walletId);
                    });
                });
            }
        } catch (error) {
            console.error('Error loading wallets:', error);
            showToast('Failed to load wallets', 'error');
        }
    }
    
    // Create a new wallet
    async function createWallet() {
        const name = document.getElementById('walletName').value;
        const network = document.getElementById('walletNetwork').value;
        const networkType = document.getElementById('walletNetworkType').value;
        const password = document.getElementById('walletPassword').value;
        const privateKey = document.getElementById('walletPrivateKey').value;
        
        if (!name) {
            showToast('Please enter a wallet name', 'warning');
            return;
        }
        
        try {
            const walletData = {
                name,
                network,
                network_type: networkType
            };
            
            if (password) {
                walletData.password = password;
            }
            
            if (privateKey) {
                walletData.private_key = privateKey;
            }
            
            const response = await fetchAPI('/alchemy/wallets', 'POST', walletData);
            
            if (response && response.success) {
                showToast(`Wallet "${name}" created successfully`, 'success');
                
                // Clear the form and close the modal
                document.getElementById('createWalletForm').reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('createWalletModal'));
                modal.hide();
                
                // Refresh wallets list
                loadWallets();
            }
        } catch (error) {
            console.error('Error creating wallet:', error);
            showToast('Failed to create wallet', 'error');
        }
    }
    
    // View wallet details
    async function viewWalletDetails(walletId) {
        try {
            const response = await fetchAPI(`/alchemy/wallets/${walletId}`);
            
            if (response && response.success) {
                const wallet = response.wallet;
                
                // Store current wallet ID
                currentWalletId = walletId;
                
                // Update wallet details
                document.getElementById('walletDetailName').textContent = wallet.name || 'Unnamed Wallet';
                document.getElementById('walletDetailAddress').textContent = wallet.address;
                document.getElementById('walletDetailNetwork').textContent = `${capitalizeFirstLetter(wallet.network)} ${wallet.network_type}`;
                document.getElementById('walletDetailBalance').textContent = wallet.balance ? 
                    `${parseFloat(wallet.balance).toFixed(6)} ${getNetworkSymbol(wallet.network)}` : 'Unknown';
                document.getElementById('walletDetailCreated').textContent = formatDate(wallet.created_at);
                
                // Set wallet ID for transaction modal
                document.getElementById('txWalletId').value = walletId;
                document.getElementById('assignWalletId').value = walletId;
                
                // Load token balances
                const tokensList = document.getElementById('tokenBalancesList');
                
                if (wallet.tokens && wallet.tokens.length > 0) {
                    tokensList.innerHTML = '';
                    
                    wallet.tokens.forEach(token => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${token.name || 'Unknown Token'}</td>
                            <td>${token.symbol || '???'}</td>
                            <td>${parseFloat(token.balance).toFixed(6)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary send-token-btn" 
                                    data-token="${token.contract_address}">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </td>
                        `;
                        tokensList.appendChild(row);
                        
                        // Also add to token select in transaction modal
                        const option = document.createElement('option');
                        option.value = token.contract_address;
                        option.textContent = `${token.symbol} (${parseFloat(token.balance).toFixed(4)})`;
                        document.getElementById('txToken').appendChild(option);
                    });
                } else {
                    tokensList.innerHTML = '<tr><td colspan="4" class="text-center">No tokens found</td></tr>';
                }
                
                // Load NFT collection
                const nftCollection = document.getElementById('nftCollection');
                
                if (wallet.nfts && wallet.nfts.length > 0) {
                    nftCollection.innerHTML = '';
                    
                    wallet.nfts.forEach(nft => {
                        const nftCard = document.createElement('div');
                        nftCard.className = 'col-md-4 col-lg-3 mb-3';
                        nftCard.innerHTML = `
                            <div class="card">
                                <img src="${nft.image_url || 'https://via.placeholder.com/200x200?text=No+Image'}" 
                                    class="card-img-top" alt="${nft.name}" style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h6 class="card-title">${nft.name || 'Unnamed NFT'}</h6>
                                    <p class="card-text small">${nft.collection || 'Unknown Collection'}</p>
                                    <p class="card-text small text-muted">Token ID: ${truncateMiddle(nft.token_id)}</p>
                                </div>
                            </div>
                        `;
                        nftCollection.appendChild(nftCard);
                    });
                } else {
                    nftCollection.innerHTML = '<div class="col-12 text-center">No NFTs found</div>';
                }
                
                // Load recent transactions
                const transactionsList = document.getElementById('transactionsList');
                
                if (wallet.recent_transactions && wallet.recent_transactions.length > 0) {
                    transactionsList.innerHTML = '';
                    
                    wallet.recent_transactions.forEach(tx => {
                        const isIncoming = tx.to_address.toLowerCase() === wallet.address.toLowerCase();
                        const counterparty = isIncoming ? tx.from_address : tx.to_address;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <span class="badge ${isIncoming ? 'bg-success' : 'bg-primary'}">
                                    ${isIncoming ? 'Receive' : 'Send'}
                                </span>
                            </td>
                            <td>${truncateAddress(counterparty)}</td>
                            <td>${tx.value ? parseFloat(tx.value).toFixed(6) : '0.00'} ${tx.asset || 'ETH'}</td>
                            <td>${formatDate(tx.timestamp)}</td>
                            <td>
                                <span class="badge ${tx.status === 'failed' ? 'bg-danger' : 'bg-success'}">
                                    ${tx.status || 'Confirmed'}
                                </span>
                            </td>
                        `;
                        transactionsList.appendChild(row);
                    });
                } else {
                    transactionsList.innerHTML = '<tr><td colspan="5" class="text-center">No transactions found</td></tr>';
                }
                
                // Show wallet details card
                document.getElementById('walletDetailsCard').style.display = 'block';
                
                // Add event listeners for send token buttons
                document.querySelectorAll('.send-token-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const tokenAddress = button.getAttribute('data-token');
                        document.getElementById('txToken').value = tokenAddress;
                        new bootstrap.Modal(document.getElementById('sendTransactionModal')).show();
                    });
                });
            }
        } catch (error) {
            console.error('Error viewing wallet details:', error);
            showToast('Failed to load wallet details', 'error');
        }
    }
    
    // Send transaction
    async function sendTransaction() {
        const walletId = document.getElementById('txWalletId').value;
        const toAddress = document.getElementById('txToAddress').value;
        const amount = document.getElementById('txAmount').value;
        const tokenAddress = document.getElementById('txToken').value;
        const gasSpeed = document.getElementById('txGasSpeed').value;
        const password = document.getElementById('txPassword').value;
        
        if (!walletId || !toAddress || !amount) {
            showToast('Please fill in all required fields', 'warning');
            return;
        }
        
        try {
            const transactionData = {
                wallet_id: walletId,
                to_address: toAddress,
                amount: parseFloat(amount),
                gas_speed: gasSpeed
            };
            
            if (tokenAddress) {
                transactionData.token_address = tokenAddress;
            }
            
            if (password) {
                transactionData.password = password;
            }
            
            const response = await fetchAPI('/alchemy/wallets/send', 'POST', transactionData);
            
            if (response && response.success) {
                showToast(`Transaction sent successfully: ${response.tx_hash}`, 'success');
                
                // Clear the form and close the modal
                document.getElementById('sendTransactionForm').reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('sendTransactionModal'));
                modal.hide();
                
                // Refresh wallet details
                viewWalletDetails(walletId);
            }
        } catch (error) {
            console.error('Error sending transaction:', error);
            showToast('Failed to send transaction', 'error');
        }
    }
    
    // Assign wallet to agent
    async function assignWalletToAgent() {
        const walletId = document.getElementById('assignWalletId').value;
        const agentId = document.getElementById('assignAgentId').value;
        
        if (!walletId || !agentId) {
            showToast('Please fill in all required fields', 'warning');
            return;
        }
        
        try {
            const assignData = {
                wallet_id: walletId,
                agent_id: agentId
            };
            
            const response = await fetchAPI('/alchemy/wallets/assign', 'POST', assignData);
            
            if (response && response.success) {
                showToast(response.message, 'success');
                
                // Clear the form and close the modal
                document.getElementById('assignWalletForm').reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('assignWalletModal'));
                modal.hide();
            }
        } catch (error) {
            console.error('Error assigning wallet:', error);
            showToast('Failed to assign wallet to agent', 'error');
        }
    }
    
    // Copy wallet address to clipboard
    function copyWalletAddress() {
        const address = document.getElementById('walletDetailAddress').textContent;
        navigator.clipboard.writeText(address).then(() => {
            showToast('Address copied to clipboard', 'success');
        }).catch(err => {
            console.error('Error copying address:', err);
            showToast('Failed to copy address', 'error');
        });
    }
    
    // Utility functions
    function truncateAddress(address) {
        if (!address) return '';
        return address.slice(0, 6) + '...' + address.slice(-4);
    }
    
    function truncateMiddle(str) {
        if (!str) return '';
        if (str.length <= 10) return str;
        return str.slice(0, 6) + '...' + str.slice(-4);
    }
    
    function getNetworkBadge(network, networkType) {
        const networkClass = `network-${network.toLowerCase()}`;
        return `<span class="network-badge ${networkClass}">${capitalizeFirstLetter(network)} ${networkType}</span>`;
    }
    
    function getNetworkSymbol(network) {
        const symbols = {
            'ethereum': 'ETH',
            'polygon': 'MATIC',
            'arbitrum': 'ETH',
            'optimism': 'ETH',
            'base': 'ETH'
        };
        return symbols[network.toLowerCase()] || 'ETH';
    }
    
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'Unknown';
        const date = new Date(dateString);
        return date.toLocaleString();
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initializeWalletSection);
</script>
