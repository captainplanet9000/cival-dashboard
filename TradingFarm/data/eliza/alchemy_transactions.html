<!-- Transactions Explorer Component -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-exchange-alt me-2"></i>
            Transaction Explorer
        </div>
        <div>
            <button class="btn btn-sm btn-primary" id="refreshTransactionsBtn">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-10">
                <div class="row g-2">
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="txFilterType">
                            <option value="all">All Types</option>
                            <option value="send">Send</option>
                            <option value="receive">Receive</option>
                            <option value="contract">Contract Interaction</option>
                            <option value="nft">NFT Transfer</option>
                            <option value="token">Token Transfer</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="txFilterStatus">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="success">Success</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="txFilterWallet">
                            <option value="all">All Wallets</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" id="txSearchInput" placeholder="Search by hash, address...">
                    </div>
                </div>
            </div>
            <div class="col-md-2 text-end">
                <button class="btn btn-sm btn-outline-primary" id="applyTxFiltersBtn">
                    <i class="fas fa-filter me-1"></i>Apply Filters
                </button>
            </div>
        </div>
        
        <!-- Transactions Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Hash</th>
                        <th>Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Value</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactionsTable">
                    <!-- Transactions will be loaded here -->
                    <tr>
                        <td colspan="8" class="text-center">Loading transactions...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="txPaginationInfo">Showing 0-0 of 0 transactions</span>
            </div>
            <nav aria-label="Transaction pagination">
                <ul class="pagination pagination-sm" id="txPagination">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                    </li>
                    <li class="page-item active">
                        <a class="page-link" href="#">1</a>
                    </li>
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Basic Information</h6>
                                <div class="row">
                                    <div class="col-md-3 text-muted">Transaction Hash:</div>
                                    <div class="col-md-9" id="txDetailHash">--</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-3 text-muted">Status:</div>
                                    <div class="col-md-9" id="txDetailStatus">--</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-3 text-muted">Block:</div>
                                    <div class="col-md-9" id="txDetailBlock">--</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-3 text-muted">Timestamp:</div>
                                    <div class="col-md-9" id="txDetailTime">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">From</h6>
                                <p id="txDetailFrom" class="mb-1">--</p>
                                <small id="txDetailFromLabel" class="text-muted">--</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">To</h6>
                                <p id="txDetailTo" class="mb-1">--</p>
                                <small id="txDetailToLabel" class="text-muted">--</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Value</h6>
                                <p id="txDetailValue" class="mb-1">--</p>
                                <small id="txDetailValueUsd" class="text-muted">--</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Gas</h6>
                                <div class="row">
                                    <div class="col-6 text-muted">Gas Price:</div>
                                    <div class="col-6 text-end" id="txDetailGasPrice">--</div>
                                </div>
                                <div class="row mt-1">
                                    <div class="col-6 text-muted">Gas Used:</div>
                                    <div class="col-6 text-end" id="txDetailGasUsed">--</div>
                                </div>
                                <div class="row mt-1">
                                    <div class="col-6 text-muted">Gas Limit:</div>
                                    <div class="col-6 text-end" id="txDetailGasLimit">--</div>
                                </div>
                                <div class="row mt-1">
                                    <div class="col-6 text-muted">Fee:</div>
                                    <div class="col-6 text-end" id="txDetailFee">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Token Transfers -->
                <div class="card bg-light mb-3" id="txTokenTransfersCard" style="display: none;">
                    <div class="card-body">
                        <h6 class="card-title">Token Transfers</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="txTokenTransfers">
                                    <!-- Token transfers will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Logs and Input Data -->
                <ul class="nav nav-tabs" id="txDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="input-data-tab" data-bs-toggle="tab" data-bs-target="#input-data" type="button" role="tab">Input Data</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">Event Logs</button>
                    </li>
                </ul>
                <div class="tab-content p-3 border border-top-0 rounded-bottom" id="txDetailTabContent">
                    <div class="tab-pane fade show active" id="input-data" role="tabpanel">
                        <pre class="bg-dark text-light p-3 rounded" id="txDetailInputData">--</pre>
                    </div>
                    <div class="tab-pane fade" id="logs" role="tabpanel">
                        <pre class="bg-dark text-light p-3 rounded" id="txDetailLogs">--</pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-outline-primary" id="txDetailExplorerLink" target="_blank">
                    <i class="fas fa-external-link-alt me-1"></i>View in Explorer
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Explorer Script -->
<script>
    // Make functions available globally
    window.initializeTransactionsPanel = initializeTransactionsPanel;
    window.refreshTransactions = refreshTransactions;
    
    // Current page and filters
    let txCurrentPage = 1;
    let txPageSize = 10;
    let txTotalPages = 1;
    let txFilters = {
        type: 'all',
        status: 'all',
        wallet: 'all',
        search: ''
    };
    
    // Initialize transactions panel
    function initializeTransactionsPanel() {
        // Set up event listeners
        document.getElementById('refreshTransactionsBtn').addEventListener('click', () => {
            refreshTransactions(currentBlockchainNetwork);
        });
        
        document.getElementById('applyTxFiltersBtn').addEventListener('click', () => {
            txFilters.type = document.getElementById('txFilterType').value;
            txFilters.status = document.getElementById('txFilterStatus').value;
            txFilters.wallet = document.getElementById('txFilterWallet').value;
            txFilters.search = document.getElementById('txSearchInput').value;
            txCurrentPage = 1;
            refreshTransactions(currentBlockchainNetwork);
        });
        
        // Load transactions
        refreshTransactions(currentBlockchainNetwork);
        
        // Load wallet options
        loadWalletOptions();
    }
    
    // Load wallet options for filter
    async function loadWalletOptions() {
        try {
            const response = await fetchAPI('/alchemy/wallets');
            
            if (response && response.success) {
                const walletSelect = document.getElementById('txFilterWallet');
                
                // Keep the "All Wallets" option
                walletSelect.innerHTML = '<option value="all">All Wallets</option>';
                
                // Add each wallet
                response.wallets.forEach(wallet => {
                    const option = document.createElement('option');
                    option.value = wallet.address;
                    option.textContent = `${wallet.name} (${truncateAddress(wallet.address)})`;
                    walletSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading wallet options:', error);
        }
    }
    
    // Refresh transactions
    async function refreshTransactions(network) {
        try {
            // Show loading
            document.getElementById('transactionsTable').innerHTML = '<tr><td colspan="8" class="text-center">Loading transactions...</td></tr>';
            
            // Build query parameters
            const queryParams = new URLSearchParams({
                network: network,
                page: txCurrentPage,
                page_size: txPageSize,
                type: txFilters.type,
                status: txFilters.status
            });
            
            if (txFilters.wallet !== 'all') {
                queryParams.append('wallet', txFilters.wallet);
            }
            
            if (txFilters.search) {
                queryParams.append('search', txFilters.search);
            }
            
            // Fetch transactions
            const response = await fetchAPI(`/alchemy/transactions?${queryParams.toString()}`);
            
            if (response && response.success) {
                const transactions = response.transactions;
                txTotalPages = response.total_pages || 1;
                
                const transactionsTable = document.getElementById('transactionsTable');
                
                if (transactions.length === 0) {
                    transactionsTable.innerHTML = '<tr><td colspan="8" class="text-center">No transactions found</td></tr>';
                    
                    // Update pagination
                    updatePagination(0, 0, 0);
                    return;
                }
                
                // Clear table
                transactionsTable.innerHTML = '';
                
                // Add each transaction
                transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    
                    // Determine type and badge
                    const txType = getTxType(tx);
                    const typeBadge = getTxTypeBadge(txType);
                    
                    // Determine status badge
                    const statusBadge = getTxStatusBadge(tx.status);
                    
                    // Format value
                    const valueDisplay = formatTxValue(tx);
                    
                    // Create row
                    row.innerHTML = `
                        <td>${truncateMiddle(tx.hash, 8)}</td>
                        <td>${typeBadge}</td>
                        <td>${truncateAddress(tx.from_address)}</td>
                        <td>${truncateAddress(tx.to_address || 'Contract Creation')}</td>
                        <td>${valueDisplay}</td>
                        <td>${formatTimeAgo(tx.timestamp)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info view-tx-btn" data-hash="${tx.hash}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    transactionsTable.appendChild(row);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-tx-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const txHash = button.getAttribute('data-hash');
                        viewTransactionDetails(txHash, network);
                    });
                });
                
                // Update pagination
                updatePagination(response.total_items, response.page, response.page_size);
            }
        } catch (error) {
            console.error('Error refreshing transactions:', error);
            showToast('Failed to load transactions', 'error');
        }
    }
    
    // View transaction details
    async function viewTransactionDetails(txHash, network) {
        try {
            const response = await fetchAPI(`/alchemy/transaction/${txHash}?network=${network}`);
            
            if (response && response.success) {
                const tx = response.transaction;
                
                // Update basic information
                document.getElementById('txDetailHash').textContent = tx.hash;
                
                // Status badge
                const statusBadge = getTxStatusBadge(tx.status);
                document.getElementById('txDetailStatus').innerHTML = statusBadge;
                
                // Block info
                document.getElementById('txDetailBlock').textContent = tx.block_number ? 
                    `${tx.block_number} (${tx.confirmations} confirmations)` : 'Pending';
                
                // Timestamp
                document.getElementById('txDetailTime').textContent = tx.timestamp ? 
                    new Date(tx.timestamp).toLocaleString() : 'Pending';
                
                // From information
                document.getElementById('txDetailFrom').textContent = tx.from_address;
                document.getElementById('txDetailFromLabel').textContent = tx.from_label || 
                    (tx.is_from_wallet ? 'Your Wallet' : 'External Address');
                
                // To information
                document.getElementById('txDetailTo').textContent = tx.to_address || 'Contract Creation';
                document.getElementById('txDetailToLabel').textContent = tx.to_label || 
                    (tx.is_to_wallet ? 'Your Wallet' : (tx.to_address ? 'External Address' : 'Contract Creation'));
                
                // Value
                const valueDisplay = tx.value ? 
                    `${parseFloat(tx.value).toFixed(6)} ${getNetworkSymbol(network)}` : '0';
                document.getElementById('txDetailValue').textContent = valueDisplay;
                
                // USD value
                const usdDisplay = tx.value_usd ? 
                    `$${parseFloat(tx.value_usd).toFixed(2)} USD` : '';
                document.getElementById('txDetailValueUsd').textContent = usdDisplay;
                
                // Gas information
                document.getElementById('txDetailGasPrice').textContent = `${tx.gas_price} Gwei`;
                document.getElementById('txDetailGasUsed').textContent = tx.gas_used || 'Pending';
                document.getElementById('txDetailGasLimit').textContent = tx.gas_limit;
                
                const feeTxt = tx.gas_used ? 
                    `${parseFloat(tx.gas_fee).toFixed(6)} ${getNetworkSymbol(network)}` : 'Pending';
                document.getElementById('txDetailFee').textContent = feeTxt;
                
                // Token transfers
                if (tx.token_transfers && tx.token_transfers.length > 0) {
                    document.getElementById('txTokenTransfersCard').style.display = 'block';
                    const tokenTransfersTable = document.getElementById('txTokenTransfers');
                    tokenTransfersTable.innerHTML = '';
                    
                    tx.token_transfers.forEach(transfer => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                ${transfer.token_symbol} 
                                <small class="text-muted">${truncateAddress(transfer.token_address)}</small>
                            </td>
                            <td>${truncateAddress(transfer.from_address)}</td>
                            <td>${truncateAddress(transfer.to_address)}</td>
                            <td>${formatTokenValue(transfer.value, transfer.token_decimals)} ${transfer.token_symbol}</td>
                        `;
                        tokenTransfersTable.appendChild(row);
                    });
                } else {
                    document.getElementById('txTokenTransfersCard').style.display = 'none';
                }
                
                // Input data
                document.getElementById('txDetailInputData').textContent = tx.input_data || '0x';
                
                // Logs
                document.getElementById('txDetailLogs').textContent = 
                    tx.logs && tx.logs.length > 0 ? JSON.stringify(tx.logs, null, 2) : 'No event logs';
                
                // Explorer link
                const explorerBaseUrl = getExplorerUrl(network);
                document.getElementById('txDetailExplorerLink').href = `${explorerBaseUrl}/tx/${tx.hash}`;
                
                // Show the modal
                new bootstrap.Modal(document.getElementById('transactionDetailsModal')).show();
            }
        } catch (error) {
            console.error('Error viewing transaction details:', error);
            showToast('Failed to load transaction details', 'error');
        }
    }
    
    // Update pagination controls
    function updatePagination(totalItems, currentPage, pageSize) {
        const totalPages = Math.ceil(totalItems / pageSize) || 1;
        txTotalPages = totalPages;
        
        // Update info text
        const start = totalItems === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, totalItems);
        document.getElementById('txPaginationInfo').textContent = `Showing ${start}-${end} of ${totalItems} transactions`;
        
        // Update pagination controls
        const pagination = document.getElementById('txPagination');
        pagination.innerHTML = '';
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" tabindex="-1">Previous</a>`;
        prevLi.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                txCurrentPage = currentPage - 1;
                refreshTransactions(currentBlockchainNetwork);
            }
        });
        pagination.appendChild(prevLi);
        
        // Page buttons (max 5)
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages && startPage > 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageLi.addEventListener('click', (e) => {
                e.preventDefault();
                txCurrentPage = i;
                refreshTransactions(currentBlockchainNetwork);
            });
            pagination.appendChild(pageLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" tabindex="-1">Next</a>`;
        nextLi.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
                txCurrentPage = currentPage + 1;
                refreshTransactions(currentBlockchainNetwork);
            }
        });
        pagination.appendChild(nextLi);
    }
    
    // Helper functions
    // Get transaction type
    function getTxType(tx) {
        if (tx.is_token_transfer) {
            return 'token';
        } else if (tx.is_nft_transfer) {
            return 'nft';
        } else if (!tx.to_address) {
            return 'contract';
        } else if (tx.is_to_wallet) {
            return 'receive';
        } else {
            return 'send';
        }
    }
    
    // Get transaction type badge
    function getTxTypeBadge(type) {
        let badgeClass, iconClass, text;
        
        switch (type) {
            case 'send':
                badgeClass = 'bg-primary';
                iconClass = 'fa-arrow-up';
                text = 'Send';
                break;
            case 'receive':
                badgeClass = 'bg-success';
                iconClass = 'fa-arrow-down';
                text = 'Receive';
                break;
            case 'contract':
                badgeClass = 'bg-warning';
                iconClass = 'fa-file-contract';
                text = 'Contract';
                break;
            case 'token':
                badgeClass = 'bg-info';
                iconClass = 'fa-coins';
                text = 'Token';
                break;
            case 'nft':
                badgeClass = 'bg-secondary';
                iconClass = 'fa-image';
                text = 'NFT';
                break;
            default:
                badgeClass = 'bg-light text-dark';
                iconClass = 'fa-question';
                text = 'Unknown';
        }
        
        return `<span class="badge ${badgeClass}"><i class="fas ${iconClass} me-1"></i>${text}</span>`;
    }
    
    // Get transaction status badge
    function getTxStatusBadge(status) {
        let badgeClass, text;
        
        switch (status) {
            case 'success':
                badgeClass = 'bg-success';
                text = 'Success';
                break;
            case 'pending':
                badgeClass = 'bg-warning';
                text = 'Pending';
                break;
            case 'failed':
                badgeClass = 'bg-danger';
                text = 'Failed';
                break;
            default:
                badgeClass = 'bg-secondary';
                text = 'Unknown';
        }
        
        return `<span class="badge ${badgeClass}">${text}</span>`;
    }
    
    // Format transaction value
    function formatTxValue(tx) {
        if (tx.is_token_transfer && tx.token) {
            return `${parseFloat(tx.token.value).toFixed(4)} ${tx.token.symbol}`;
        } else if (tx.is_nft_transfer && tx.nft) {
            return `NFT #${truncateMiddle(tx.nft.token_id, 6)}`;
        } else {
            return tx.value ? 
                `${parseFloat(tx.value).toFixed(6)} ${getNetworkSymbol(currentBlockchainNetwork)}` : 
                '0';
        }
    }
    
    // Format token value based on decimals
    function formatTokenValue(value, decimals) {
        const divisor = Math.pow(10, decimals || 18);
        return (value / divisor).toFixed(4);
    }
    
    // Format time ago
    function formatTimeAgo(timestamp) {
        if (!timestamp) return 'Pending';
        
        const now = new Date();
        const txTime = new Date(timestamp);
        const diffMs = now - txTime;
        const diffSec = Math.floor(diffMs / 1000);
        
        if (diffSec < 60) {
            return 'Just now';
        } else if (diffSec < 3600) {
            const min = Math.floor(diffSec / 60);
            return `${min} min${min > 1 ? 's' : ''} ago`;
        } else if (diffSec < 86400) {
            const hours = Math.floor(diffSec / 3600);
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        } else {
            const days = Math.floor(diffSec / 86400);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }
    }
    
    // Get blockchain explorer URL
    function getExplorerUrl(network) {
        const explorers = {
            'ethereum': {
                'mainnet': 'https://etherscan.io',
                'goerli': 'https://goerli.etherscan.io'
            },
            'polygon': {
                'mainnet': 'https://polygonscan.com',
                'mumbai': 'https://mumbai.polygonscan.com'
            },
            'arbitrum': {
                'mainnet': 'https://arbiscan.io',
                'goerli': 'https://goerli.arbiscan.io'
            },
            'optimism': {
                'mainnet': 'https://optimistic.etherscan.io',
                'goerli': 'https://goerli-optimism.etherscan.io'
            },
            'base': {
                'mainnet': 'https://basescan.org',
                'goerli': 'https://goerli.basescan.org'
            }
        };
        
        // Default to using goerli testnet for now
        return explorers[network]?.goerli || explorers.ethereum.goerli;
    }
    
    // Truncate address
    function truncateAddress(address) {
        if (!address) return '--';
        return address.slice(0, 6) + '...' + address.slice(-4);
    }
    
    // Truncate middle of string
    function truncateMiddle(str, keepChars = 4) {
        if (!str) return '--';
        if (str.length <= keepChars * 2) return str;
        return str.slice(0, keepChars) + '...' + str.slice(-keepChars);
    }
</script>
