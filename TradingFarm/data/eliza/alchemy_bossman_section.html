<!-- Bossman Controller Section -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-user-tie me-2"></i>
                    Bossman Controller
                </div>
                <div>
                    <button class="btn btn-sm btn-success" id="startBossmanBtn">
                        <i class="fas fa-play me-1"></i>Start
                    </button>
                    <button class="btn btn-sm btn-danger" id="stopBossmanBtn">
                        <i class="fas fa-stop me-1"></i>Stop
                    </button>
                    <button class="btn btn-sm btn-primary" id="refreshBossmanBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Status</h6>
                                <h2 id="bossmanStatus">
                                    <span class="badge bg-secondary">Unknown</span>
                                </h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Agents Monitored</h6>
                                <h2 id="bossmanAgentsCount">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Networks</h6>
                                <h2 id="bossmanNetworksCount">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Total Assets</h6>
                                <h2 id="bossmanTotalAssets">0.00 ETH</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Management -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-robot me-2"></i>
                Agent Management
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Wallet</th>
                                <th>Balance</th>
                                <th>Network</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsList">
                            <!-- Agents will be loaded here -->
                            <tr>
                                <td colspan="7" class="text-center">Loading agents...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Command Center -->
<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-terminal me-2"></i>
                Command Center
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="input-group">
                        <select class="form-select" id="commandType">
                            <option value="market_scan">Market Scan</option>
                            <option value="rebalance">Rebalance Assets</option>
                            <option value="risk_assessment">Risk Assessment</option>
                            <option value="agent_command">Agent Command</option>
                            <option value="custom">Custom Command</option>
                        </select>
                        <input type="text" class="form-control" id="commandParams" placeholder="Parameters (JSON)">
                        <button class="btn btn-primary" id="sendCommandBtn">
                            <i class="fas fa-paper-plane me-1"></i>Send
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary command-preset" data-command="market_scan" data-params='{"networks": ["ethereum", "polygon"]}'>
                            Market Scan
                        </button>
                        <button class="btn btn-outline-secondary command-preset" data-command="rebalance" data-params='{"strategy": "risk_minimization"}'>
                            Rebalance
                        </button>
                        <button class="btn btn-outline-secondary command-preset" data-command="risk_assessment" data-params='{}'>
                            Risk Check
                        </button>
                    </div>
                </div>
                
                <div class="card bg-dark text-light">
                    <div class="card-body">
                        <h6 class="card-title text-light">Command History</h6>
                        <div id="commandHistory" style="height: 200px; overflow-y: auto; font-family: monospace;">
                            <!-- Command history will be displayed here -->
                            <div class="text-muted">No commands executed yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line me-2"></i>
                Market Overview
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Network Selection</label>
                    <div class="btn-group w-100" role="group" id="marketNetworkBtns">
                        <button class="btn btn-outline-primary active" data-network="ethereum">Ethereum</button>
                        <button class="btn btn-outline-primary" data-network="polygon">Polygon</button>
                        <button class="btn btn-outline-primary" data-network="arbitrum">Arbitrum</button>
                    </div>
                </div>
                
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Gas Prices</h6>
                        <div class="d-flex justify-content-between">
                            <div class="text-center">
                                <div class="fw-bold">Low</div>
                                <div id="gasLow">-- Gwei</div>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold">Medium</div>
                                <div id="gasMedium">-- Gwei</div>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold">High</div>
                                <div id="gasHigh">-- Gwei</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Market Indicators</h6>
                        <ul class="list-group list-group-flush" id="marketIndicators">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ETH Price
                                <span id="ethPrice">$0.00</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                24h Volume
                                <span id="marketVolume">$0.00</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Market Sentiment
                                <span id="marketSentiment">Neutral</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Asset Rebalancing -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-balance-scale me-2"></i>
                Asset Rebalancing
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Rebalance Settings</h6>
                                <form id="rebalanceForm">
                                    <div class="mb-3">
                                        <label class="form-label">Rebalance Strategy</label>
                                        <select class="form-select" id="rebalanceStrategy">
                                            <option value="risk_minimization">Risk Minimization</option>
                                            <option value="profit_maximization">Profit Maximization</option>
                                            <option value="fee_optimization">Fee Optimization</option>
                                            <option value="custom">Custom Allocation</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Target Networks</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="ethereum" id="networkEthereum" checked>
                                            <label class="form-check-label" for="networkEthereum">Ethereum</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="polygon" id="networkPolygon" checked>
                                            <label class="form-check-label" for="networkPolygon">Polygon</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="arbitrum" id="networkArbitrum" checked>
                                            <label class="form-check-label" for="networkArbitrum">Arbitrum</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Gas Price Preference</label>
                                        <select class="form-select" id="gasPreference">
                                            <option value="low">Low (Slower)</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="high">High (Faster)</option>
                                        </select>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" id="executeRebalanceBtn">
                                        <i class="fas fa-sync-alt me-1"></i>Execute Rebalance
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Current Allocation</h6>
                                <div id="allocationChart" style="height: 250px;">
                                    <!-- Allocation chart placeholder -->
                                    <div class="text-center py-5 text-muted">
                                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                                        <p>Asset allocation chart will be displayed here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-light mt-3">
                    <div class="card-body">
                        <h6 class="card-title">Rebalance History</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Strategy</th>
                                        <th>Networks</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="rebalanceHistory">
                                    <!-- Rebalance history will be loaded here -->
                                    <tr>
                                        <td colspan="5" class="text-center">No rebalance history found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bossman Controller Script -->
<script>
    // Initialize Bossman section
    function initializeBossmanSection() {
        // Load Bossman status on initialization
        loadBossmanStatus();
        
        // Set up event listeners
        document.getElementById('refreshBossmanBtn').addEventListener('click', loadBossmanStatus);
        document.getElementById('startBossmanBtn').addEventListener('click', startBossman);
        document.getElementById('stopBossmanBtn').addEventListener('click', stopBossman);
        document.getElementById('sendCommandBtn').addEventListener('click', sendCommand);
        document.getElementById('executeRebalanceBtn').addEventListener('click', executeRebalance);
        
        // Set up command presets
        document.querySelectorAll('.command-preset').forEach(button => {
            button.addEventListener('click', () => {
                const command = button.getAttribute('data-command');
                const params = button.getAttribute('data-params');
                
                document.getElementById('commandType').value = command;
                document.getElementById('commandParams').value = params;
            });
        });
        
        // Set up market network buttons
        document.querySelectorAll('#marketNetworkBtns button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('#marketNetworkBtns button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                loadMarketData(button.getAttribute('data-network'));
            });
        });
        
        // Load initial market data
        loadMarketData('ethereum');
    }
    
    // Load Bossman status from API
    async function loadBossmanStatus() {
        try {
            const response = await fetchAPI('/bossman/status');
            
            if (response && response.success) {
                const status = response.status;
                
                // Update status badge
                const statusBadge = document.getElementById('bossmanStatus');
                if (status.active) {
                    statusBadge.innerHTML = '<span class="badge bg-success">Active</span>';
                } else {
                    statusBadge.innerHTML = '<span class="badge bg-danger">Inactive</span>';
                }
                
                // Update metrics
                document.getElementById('bossmanAgentsCount').textContent = status.metrics.agents_monitored || 0;
                document.getElementById('bossmanNetworksCount').textContent = status.metrics.chains_monitored?.length || 0;
                document.getElementById('bossmanTotalAssets').textContent = `${parseFloat(status.metrics.total_assets || 0).toFixed(4)} ETH`;
                
                // Load agents
                if (status.agents && status.agents.length > 0) {
                    const agentsList = document.getElementById('agentsList');
                    agentsList.innerHTML = '';
                    
                    status.agents.forEach(agent => {
                        const statusClass = agent.status === 'active' ? 'bg-success' : 'bg-secondary';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${agent.id}</td>
                            <td>${agent.name || 'Unnamed Agent'}</td>
                            <td><span class="badge ${statusClass}">${agent.status}</span></td>
                            <td>${agent.wallet_address ? truncateAddress(agent.wallet_address) : 'No Wallet'}</td>
                            <td>${agent.balance ? parseFloat(agent.balance).toFixed(6) : '0.00'} ${agent.network_symbol || 'ETH'}</td>
                            <td><span class="network-badge network-${agent.network || 'ethereum'}">${capitalizeFirstLetter(agent.network || 'ethereum')}</span></td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-success agent-action-btn" data-action="start" data-id="${agent.id}">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-outline-danger agent-action-btn" data-action="stop" data-id="${agent.id}">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                    <button class="btn btn-outline-primary agent-action-btn" data-action="info" data-id="${agent.id}">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        agentsList.appendChild(row);
                    });
                    
                    // Add event listeners to agent action buttons
                    document.querySelectorAll('.agent-action-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            const action = button.getAttribute('data-action');
                            const agentId = button.getAttribute('data-id');
                            executeAgentAction(action, agentId);
                        });
                    });
                } else {
                    document.getElementById('agentsList').innerHTML = '<tr><td colspan="7" class="text-center">No agents found</td></tr>';
                }
                
                // Load rebalance history
                if (status.rebalance_history && status.rebalance_history.length > 0) {
                    const historyList = document.getElementById('rebalanceHistory');
                    historyList.innerHTML = '';
                    
                    status.rebalance_history.forEach(item => {
                        const statusClass = item.status === 'completed' ? 'bg-success' : 
                                          (item.status === 'failed' ? 'bg-danger' : 'bg-warning');
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(item.timestamp)}</td>
                            <td>${item.strategy}</td>
                            <td>${item.networks.join(', ')}</td>
                            <td><span class="badge ${statusClass}">${item.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-info view-rebalance-btn" data-id="${item.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                        historyList.appendChild(row);
                    });
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.view-rebalance-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            const rebalanceId = button.getAttribute('data-id');
                            viewRebalanceDetails(rebalanceId);
                        });
                    });
                } else {
                    document.getElementById('rebalanceHistory').innerHTML = '<tr><td colspan="5" class="text-center">No rebalance history found</td></tr>';
                }
            }
        } catch (error) {
            console.error('Error loading Bossman status:', error);
            showToast('Failed to load Bossman status', 'error');
        }
    }
    
    // Start Bossman
    async function startBossman() {
        try {
            const response = await fetchAPI('/bossman/start', 'POST');
            
            if (response && response.success) {
                showToast('Bossman started successfully', 'success');
                loadBossmanStatus();
            }
        } catch (error) {
            console.error('Error starting Bossman:', error);
            showToast('Failed to start Bossman', 'error');
        }
    }
    
    // Stop Bossman
    async function stopBossman() {
        try {
            const response = await fetchAPI('/bossman/stop', 'POST');
            
            if (response && response.success) {
                showToast('Bossman stopped successfully', 'success');
                loadBossmanStatus();
            }
        } catch (error) {
            console.error('Error stopping Bossman:', error);
            showToast('Failed to stop Bossman', 'error');
        }
    }
    
    // Send command to Bossman
    async function sendCommand() {
        const commandType = document.getElementById('commandType').value;
        const commandParams = document.getElementById('commandParams').value;
        
        if (!commandType) {
            showToast('Please select a command type', 'warning');
            return;
        }
        
        try {
            let params = {};
            
            if (commandParams) {
                try {
                    params = JSON.parse(commandParams);
                } catch (e) {
                    showToast('Invalid JSON parameters', 'error');
                    return;
                }
            }
            
            const commandData = {
                command: commandType,
                parameters: params
            };
            
            const response = await fetchAPI('/bossman/command', 'POST', commandData);
            
            if (response && response.success) {
                showToast(`Command ${commandType} sent successfully`, 'success');
                
                // Add to command history
                const historyDiv = document.getElementById('commandHistory');
                const timestamp = new Date().toLocaleTimeString();
                const historyItem = document.createElement('div');
                historyItem.innerHTML = `
                    <span class="text-muted">[${timestamp}]</span> 
                    <span class="text-success">${commandType}</span>: 
                    <span class="text-light">${JSON.stringify(params)}</span>
                    <hr class="border-secondary my-1">
                `;
                historyDiv.prepend(historyItem);
                
                // If it's a market scan, update market data
                if (commandType === 'market_scan') {
                    setTimeout(() => {
                        const activeNetwork = document.querySelector('#marketNetworkBtns button.active').getAttribute('data-network');
                        loadMarketData(activeNetwork);
                    }, 2000);
                }
            }
        } catch (error) {
            console.error('Error sending command:', error);
            showToast('Failed to send command', 'error');
        }
    }
    
    // Execute agent action
    async function executeAgentAction(action, agentId) {
        try {
            const actionData = {
                agent_id: agentId,
                action: action
            };
            
            const response = await fetchAPI('/bossman/agent-action', 'POST', actionData);
            
            if (response && response.success) {
                showToast(`Agent action ${action} executed successfully`, 'success');
                loadBossmanStatus();
            }
        } catch (error) {
            console.error('Error executing agent action:', error);
            showToast(`Failed to execute agent action: ${action}`, 'error');
        }
    }
    
    // Load market data
    async function loadMarketData(network) {
        try {
            const response = await fetchAPI(`/bossman/market-data?network=${network}`);
            
            if (response && response.success) {
                const data = response.data;
                
                // Update gas prices
                document.getElementById('gasLow').textContent = `${data.gas_prices.low} Gwei`;
                document.getElementById('gasMedium').textContent = `${data.gas_prices.medium} Gwei`;
                document.getElementById('gasHigh').textContent = `${data.gas_prices.high} Gwei`;
                
                // Update market indicators
                document.getElementById('ethPrice').textContent = `$${parseFloat(data.token_prices.eth || 0).toFixed(2)}`;
                document.getElementById('marketVolume').textContent = `$${formatNumber(data.market_metrics.volume_24h || 0)}`;
                document.getElementById('marketSentiment').textContent = data.market_metrics.sentiment || 'Neutral';
                
                // Update sentiment color
                const sentimentElement = document.getElementById('marketSentiment');
                if (data.market_metrics.sentiment === 'Bullish') {
                    sentimentElement.className = 'text-success';
                } else if (data.market_metrics.sentiment === 'Bearish') {
                    sentimentElement.className = 'text-danger';
                } else {
                    sentimentElement.className = '';
                }
            }
        } catch (error) {
            console.error('Error loading market data:', error);
            showToast('Failed to load market data', 'error');
        }
    }
    
    // Execute rebalance
    async function executeRebalance() {
        const strategy = document.getElementById('rebalanceStrategy').value;
        const gasPreference = document.getElementById('gasPreference').value;
        
        // Get selected networks
        const networks = [];
        if (document.getElementById('networkEthereum').checked) networks.push('ethereum');
        if (document.getElementById('networkPolygon').checked) networks.push('polygon');
        if (document.getElementById('networkArbitrum').checked) networks.push('arbitrum');
        
        if (networks.length === 0) {
            showToast('Please select at least one network', 'warning');
            return;
        }
        
        try {
            const rebalanceData = {
                strategy: strategy,
                networks: networks,
                gas_preference: gasPreference
            };
            
            const response = await fetchAPI('/bossman/rebalance', 'POST', rebalanceData);
            
            if (response && response.success) {
                showToast('Rebalance operation started successfully', 'success');
                
                // Add to command history
                const historyDiv = document.getElementById('commandHistory');
                const timestamp = new Date().toLocaleTimeString();
                const historyItem = document.createElement('div');
                historyItem.innerHTML = `
                    <span class="text-muted">[${timestamp}]</span> 
                    <span class="text-success">rebalance</span>: 
                    <span class="text-light">${JSON.stringify(rebalanceData)}</span>
                    <hr class="border-secondary my-1">
                `;
                historyDiv.prepend(historyItem);
                
                // Refresh status after a delay
                setTimeout(loadBossmanStatus, 3000);
            }
        } catch (error) {
            console.error('Error executing rebalance:', error);
            showToast('Failed to execute rebalance', 'error');
        }
    }
    
    // View rebalance details
    function viewRebalanceDetails(rebalanceId) {
        // This would typically open a modal with rebalance details
        // For simplicity, we'll just show a toast
        showToast(`Viewing rebalance details for ID: ${rebalanceId}`, 'info');
    }
    
    // Helper function to format large numbers
    function formatNumber(num) {
        if (num >= 1000000000) {
            return (num / 1000000000).toFixed(2) + 'B';
        }
        if (num >= 1000000) {
            return (num / 1000000).toFixed(2) + 'M';
        }
        if (num >= 1000) {
            return (num / 1000).toFixed(2) + 'K';
        }
        return num.toFixed(2);
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initializeBossmanSection);
</script>
